<p-table
  #stepsTable
  dataKey="id"
  [rowTrackBy]="trackSvc.trackStep"
  styleClass="p-datatable-sm"
  [value]="steps()"
  [customSort]="true"
  [rowExpandMode]="focus() ? 'single' : 'multiple'"
  [defaultSortOrder]="-1"
  [paginator]="!focus() && !preferences().disablePaginator"
  [rows]="preferences().rows"
  [rowsPerPageOptions]="[25, 50, 100, 1000]"
  (rowsChange)="setRows($event)"
  [showCurrentPageReport]="true"
  (sortFunction)="sortSteps$.next($event)"
>
  <ng-template pTemplate="header">
    <tr>
      <!-- Row actions -->
      <th class="w-0 px-1">
        <button
          pButton
          pRipple
          type="button"
          class="p-button-outlined p-button-rounded"
          icon="fa-solid fa-table-columns"
          [pTooltip]="'steps.openColumnSettings' | translate"
          (click)="contentSvc.showColumns$.next()"
        ></button>
      </th>
      <!-- Checkbox -->
      @if (!focus() && columnsState().checkbox.show) {
        <th>
          <div class="d-flex align-items-center justify-content-center">
            <i class="fa-solid fa-square-check"></i>
            @if (itemsModified().checked || recipesModified().checked) {
              <button
                pButton
                pRipple
                type="button"
                class="ms-2 p-button-text p-button-rounded"
                icon="fa-solid fa-rotate-left"
                [pTooltip]="'steps.checkedUndoTooltip' | translate"
                (click)="resetChecked()"
              ></button>
            }
          </div>
        </th>
      }
      <!-- Tree -->
      @if (!focus() && columnsState().tree.show) {
        <th>{{ 'options.column.tree' | translate }}</th>
      }
      <!-- Items (Value / Icon)-->
      <th colspan="2" pSortableColumn="items">
        <div class="d-flex align-items-center">
          <span>{{ dispRateInfo().itemsLabel | translate }}</span>
          @if (!focus()) {
            <p-sortIcon field="items"></p-sortIcon>
          }
          @if (itemsModified().excluded) {
            <button
              pButton
              pRipple
              type="button"
              class="ms-2 p-button-text p-button-rounded"
              icon="fa-solid fa-rotate-left"
              [pTooltip]="'steps.itemsUndoTooltip' | translate"
              (click)="resetExcluded(); $event.stopImmediatePropagation()"
            ></button>
          }
        </div>
      </th>
      <!-- Belts -->
      @if (columnsState().belts.show) {
        <th colspan="2" pSortableColumn="belts">
          <div class="d-flex align-items-center">
            <span>{{ 'options.column.belts' | translate }}</span>
            @if (!focus()) {
              <p-sortIcon field="belts"></p-sortIcon>
            }
            @if (itemsModified().belts) {
              <button
                pButton
                pRipple
                type="button"
                class="ms-2 p-button-text p-button-rounded"
                icon="fa-solid fa-rotate-left"
                [pTooltip]="'steps.beltsUndoTooltip' | translate"
                (click)="resetBelts(); $event.stopImmediatePropagation()"
              ></button>
            }
          </div>
        </th>
      }
      <!-- Wagons -->
      @if (columnsState().wagons.show) {
        <th colspan="2" pSortableColumn="wagons">
          <div class="d-flex align-items-center">
            <span>{{ dispRateInfo().wagonsLabel | translate }}</span>
            @if (!focus()) {
              <p-sortIcon field="wagons"></p-sortIcon>
            }
            @if (itemsModified().wagons) {
              <button
                pButton
                pRipple
                type="button"
                class="ms-2 p-button-text p-button-rounded"
                icon="fa-solid fa-rotate-left"
                [pTooltip]="'steps.wagonsUndoTooltip' | translate"
                (click)="resetWagons(); $event.stopImmediatePropagation()"
              ></button>
            }
          </div>
        </th>
      }
      <!-- Machines -->
      <th colspan="2" pSortableColumn="machines">
        <div class="d-flex align-items-center">
          <span>{{ 'options.column.machines' | translate }}</span>
          @if (!focus()) {
            <p-sortIcon field="machines"></p-sortIcon>
          }
          @if (recipesModified().machines) {
            <button
              pButton
              pRipple
              type="button"
              class="ms-2 p-button-text p-button-rounded"
              icon="fa-solid fa-rotate-left"
              [pTooltip]="'steps.machinesUndoTooltip' | translate"
              (click)="resetMachines(); $event.stopImmediatePropagation()"
            ></button>
          }
        </div>
      </th>
      <!-- Beacons -->
      @if (columnsState().beacons.show) {
        <th colspan="2">
          <div class="d-flex align-items-center">
            <span>{{ 'options.column.beacons' | translate }}</span>
            @if (recipesModified().beacons) {
              <button
                pButton
                pRipple
                type="button"
                class="ms-2 p-button-text p-button-rounded"
                icon="fa-solid fa-rotate-left"
                [pTooltip]="'steps.beaconsUndoTooltip' | translate"
                (click)="resetBeacons()"
              ></button>
            }
          </div>
        </th>
      }
      <!-- Power -->
      @if (columnsState().power.show) {
        <th pSortableColumn="power">
          <div class="d-flex align-items-center">
            <span>{{ 'options.column.power' | translate }}</span>
            @if (!focus()) {
              <p-sortIcon field="power"></p-sortIcon>
            }
          </div>
        </th>
      }
      <!-- Pollution -->
      @if (columnsState().pollution.show) {
        <th pSortableColumn="pollution">
          <div class="d-flex align-items-center">
            <span>{{ dispRateInfo().pollutionLabel | translate }}</span>
            @if (!focus()) {
              <p-sortIcon field="pollution"></p-sortIcon>
            }
          </div>
        </th>
      }
      <!-- Link -->
      @if (columnsState().link.show) {
        <th class="w-0 px-1">
          <button
            pButton
            pRipple
            type="button"
            class="p-button-outlined p-button-rounded"
            icon="fa-solid fa-file-arrow-down"
            [pTooltip]="'steps.downloadTooltip' | translate"
            tooltipPosition="left"
            (click)="exportSvc.stepsToCsv(steps())"
          ></button>
        </th>
      }
    </tr>
  </ng-template>
  <ng-template pTemplate="body" let-_step let-expanded="expanded">
    @if (_step | asStep; as step) {
      <tr>
        <!-- Expand row -->
        <td class="w-0 px-1 position-relative">
          <div [id]="'step_' + step.id" class="fragment"></div>
          @for (item of stepDetails()[step.id].tabs; track item.id) {
            <div
              [id]="'step_' + step.id + '_' + item.label"
              class="fragment"
            ></div>
          }
          <div class="d-flex">
            <button
              pButton
              pRipple
              type="button"
              class="p-button-text p-button-rounded transition-ease"
              [class.fa-rotate-90]="expanded"
              icon="fa-solid fa-angle-right"
              [pTooltip]="
                (expanded ? 'steps.hideDetails' : 'steps.showDetails')
                  | translate
              "
              [pRowToggler]="step"
            ></button>
          </div>
        </td>
        <!-- Checkbox -->
        @if (!focus() && columnsState().checkbox.show) {
          <td>
            <div class="d-flex justify-content-center">
              <p-checkbox
                [binary]="true"
                [ngModel]="step.checked"
                (onChange)="changeStepChecked(step, $event.checked)"
              ></p-checkbox>
            </div>
          </td>
        }
        <!-- Tree -->
        @if (!focus() && columnsState().tree.show) {
          <td class="overflow-hidden px-1 py-0">
            <div class="d-flex align-items-center links">
              @if (!stepsTable.sortField && stepTree()[step.id]?.length) {
                @for (i of stepTree()[step.id]; track i; let last = $last) {
                  <div
                    class="connect"
                    [class.trail]="i"
                    [class.last]="last"
                  ></div>
                }
                <div class="indent"></div>
              }
              <div class="icon">
                @if (step.itemId && step.recipeObjectiveId == null) {
                  <button
                    pButton
                    pRipple
                    type="button"
                    class="hover-action p-button-text"
                    [class.hover-active]="itemsState()[step.itemId].excluded"
                    [icon]="step.itemId | iconSmClass"
                    [pTooltip]="tooltip"
                    (click)="
                      setItemExcluded(
                        step.itemId,
                        !itemsState()[step.itemId].excluded
                      )
                    "
                  >
                    <i class="hover-icon fa-solid fa-eye-slash"></i>
                    <ng-template #tooltip>
                      <lab-tooltip [id]="step.itemId"></lab-tooltip>
                    </ng-template>
                  </button>
                } @else {
                  <i
                    [class]="step.recipeId | iconSmClass: 'recipe'"
                    [pTooltip]="tooltip"
                  >
                    @if (step.recipeObjectiveId != null) {
                      <span>#{{ step.recipeObjectiveId }}</span>
                    }
                    <ng-template #tooltip>
                      @if (step.recipeId) {
                        <lab-tooltip
                          [id]="step.recipeId"
                          type="recipe"
                        ></lab-tooltip>
                      }
                    </ng-template>
                  </i>
                }
              </div>
              @if (step.itemId && data().itemEntities[step.itemId]; as item) {
                <span>
                  {{ item.name }}
                </span>
              } @else {
                @if (
                  step.recipeId && data().recipeEntities[step.recipeId];
                  as recipe
                ) {
                  <span style="white-space: nowrap">{{ recipe.name }}</span>
                }
              }
            </div>
          </td>
        }
        <!-- Items (Value / Icon) -->
        @if (step.itemId && step.items) {
          <td class="w-0 text-end">
            @if (step.surplus && step.surplus.nonzero()) {
              <span class="monospace"
                >(+{{ step.surplus | rate: columnsState().items.precision }})
              </span>
            }
            <span class="monospace">{{
              step.items.sub(step.surplus ?? rational(0))
                | rate: columnsState().items.precision
            }}</span>
          </td>
          <td class="ps-0">
            <div class="d-flex align-items-center">
              @if (
                !preferences().hideDuplicateIcons || !columnsState().tree.show
              ) {
                <button
                  pButton
                  pRipple
                  type="button"
                  class="hover-action p-button-text"
                  [class.hover-active]="itemsState()[step.itemId].excluded"
                  [icon]="step.itemId | iconSmClass"
                  [pTooltip]="tooltip"
                  (click)="
                    setItemExcluded(
                      step.itemId,
                      !itemsState()[step.itemId].excluded
                    )
                  "
                >
                  <i class="hover-icon fa-solid fa-eye-slash"></i>
                  <ng-template #tooltip>
                    <lab-tooltip [id]="step.itemId"></lab-tooltip>
                  </ng-template>
                </button>
              }
            </div>
          </td>
        } @else {
          <td colspan="2"></td>
        }
        <!-- Belts -->
        @if (columnsState().belts.show) {
          @if (step.itemId && step.belts) {
            @if (itemsState()[step.itemId].beltId; as beltId) {
              <td class="w-0 text-end">
                <span class="monospace">{{
                  step.belts | rate: columnsState().belts.precision
                }}</span>
              </td>
              <td class="ps-0">
                <div class="d-flex align-items-center">
                  <!-- Belt dropdown -->
                  @if (
                    data().beltIds.indexOf(beltId) !== -1 && settings().beltId;
                    as beltId
                  ) {
                    <p-dropdown
                      labDropdownBase="icon"
                      [pTooltip]="tooltip"
                      [ngModel]="beltId"
                      [options]="options().belts"
                      (onChange)="setBelt(step.itemId, $event.value, beltId)"
                    >
                      <ng-template pTemplate="selectedItem" let-item>
                        @if (item) {
                          <div class="d-flex">
                            <i [class]="item.value | iconSmClass"></i>
                          </div>
                        }
                      </ng-template>
                      <ng-template pTemplate="item" let-item>
                        <div
                          class="d-flex align-items-center py-2 w-100 h-100"
                          [pTooltip]="tooltip"
                        >
                          <i [class]="item.value | iconSmClass"></i>
                          <div class="ms-3 text-truncate">
                            {{ item.label }}
                          </div>
                          <ng-template #tooltip>
                            <lab-tooltip
                              [id]="item.value"
                              type="belt"
                            ></lab-tooltip>
                          </ng-template>
                        </div>
                      </ng-template>
                      <ng-template #tooltip>
                        <lab-tooltip [id]="beltId" type="belt"></lab-tooltip>
                      </ng-template>
                    </p-dropdown>
                  } @else {
                    @if (
                      data().pipeIds.indexOf(beltId) !== -1 &&
                        settings().pipeId;
                      as pipeId
                    ) {
                      <!-- Pipes dropdown -->
                      <p-dropdown
                        labDropdownBase="icon"
                        [pTooltip]="tooltip"
                        [ngModel]="beltId"
                        [options]="options().pipes"
                        (onChange)="setBelt(step.itemId, $event.value, pipeId)"
                      >
                        <ng-template pTemplate="selectedItem" let-item>
                          <div class="d-flex">
                            <i [class]="item.value | iconSmClass"></i>
                          </div>
                        </ng-template>
                        <ng-template pTemplate="item" let-item>
                          <div
                            class="d-flex align-items-center py-2 w-100 h-100"
                            [pTooltip]="tooltip"
                          >
                            <i [class]="item.value | iconSmClass"></i>
                            <div class="ms-3 text-truncate">
                              {{ item.label }}
                            </div>
                            <ng-template #tooltip>
                              <lab-tooltip
                                [id]="item.value"
                                type="pipe"
                              ></lab-tooltip>
                            </ng-template>
                          </div>
                        </ng-template>
                        <ng-template #tooltip>
                          <lab-tooltip [id]="beltId" type="pipe"></lab-tooltip>
                        </ng-template>
                      </p-dropdown>
                    } @else {
                      <!-- Pipe icon only -->
                      <i [class]="beltId | iconClass" [pTooltip]="tooltip">
                        <ng-template #tooltip>
                          <lab-tooltip [id]="beltId" type="pipe"></lab-tooltip>
                        </ng-template>
                      </i>
                    }
                  }
                </div>
              </td>
            }
          } @else {
            <td colspan="2"></td>
          }
        }
        <!-- Wagons -->
        @if (columnsState().wagons.show) {
          @if (step.itemId && step.wagons) {
            @if (itemsState()[step.itemId].wagonId; as wagonId) {
              <td class="w-0 text-end">
                <span class="monospace">{{
                  step.wagons | rate: columnsState().wagons.precision
                }}</span>
              </td>
              <td class="ps-0">
                <div class="d-flex align-items-center">
                  <!-- Cargo wagon dropdown -->
                  @if (
                    data().cargoWagonIds.indexOf(wagonId) !== -1 &&
                      settings().cargoWagonId;
                    as cargoWagonId
                  ) {
                    <p-dropdown
                      labDropdownBase="icon"
                      [pTooltip]="tooltip"
                      [ngModel]="wagonId"
                      [options]="options().cargoWagons"
                      (onChange)="
                        setWagon(step.itemId, $event.value, cargoWagonId)
                      "
                    >
                      <ng-template pTemplate="selectedItem" let-item>
                        @if (item) {
                          <div class="d-flex">
                            <i [class]="item.value | iconSmClass"></i>
                          </div>
                        }
                      </ng-template>
                      <ng-template pTemplate="item" let-item>
                        <div
                          class="d-flex align-items-center py-2 w-100 h-100"
                          [pTooltip]="tooltip"
                        >
                          <i [class]="item.value | iconSmClass"></i>
                          <div class="ms-3 text-truncate">
                            {{ item.label }}
                          </div>
                          <ng-template #tooltip>
                            <lab-tooltip
                              [id]="item.value"
                              type="cargo-wagon"
                            ></lab-tooltip>
                          </ng-template>
                        </div>
                      </ng-template>
                      <ng-template #tooltip>
                        <lab-tooltip
                          [id]="wagonId"
                          type="cargo-wagon"
                        ></lab-tooltip>
                      </ng-template>
                    </p-dropdown>
                  } @else {
                    <!-- Fluid wagon dropdown -->
                    @if (
                      data().fluidWagonIds.indexOf(wagonId) !== -1 &&
                        settings().fluidWagonId;
                      as fluidWagonId
                    ) {
                      <p-dropdown
                        labDropdownBase="icon"
                        [pTooltip]="tooltip"
                        [ngModel]="wagonId"
                        [options]="options().fluidWagons"
                        (onChange)="
                          setWagon(step.itemId, $event.value, fluidWagonId)
                        "
                      >
                        <ng-template pTemplate="selectedItem" let-item>
                          @if (item) {
                            <div class="d-flex">
                              <i [class]="item.value | iconSmClass"></i>
                            </div>
                          }
                        </ng-template>
                        <ng-template pTemplate="item" let-item>
                          <div
                            class="d-flex align-items-center py-2 w-100 h-100"
                            [pTooltip]="tooltip"
                          >
                            <i [class]="item.value | iconSmClass"></i>
                            <div class="ms-3 text-truncate">
                              {{ item.label }}
                            </div>
                          </div>
                          <ng-template #tooltip>
                            <lab-tooltip
                              [id]="item.value"
                              type="fluid-wagon"
                            ></lab-tooltip>
                          </ng-template>
                        </ng-template>
                        <ng-template #tooltip>
                          <lab-tooltip
                            [id]="wagonId"
                            type="fluid-wagon"
                          ></lab-tooltip>
                        </ng-template>
                      </p-dropdown>
                    }
                  }
                </div>
              </td>
            }
          } @else {
            <td colspan="2"></td>
          }
        }
        <!-- Machines -->
        @if (step.recipeSettings?.machineId; as machineId) {
          <td class="w-0 text-end">
            @if (
              step.machines &&
              step.machines.nonzero() &&
              (machineId | machineShowRate: data().game)
            ) {
              <span class="monospace">{{
                step.machines
                  | machineRate: columnsState().machines.precision : machineId
              }}</span>
            }
          </td>
          <td class="ps-0">
            @if (step.recipeId && step.recipe && step.recipeSettings) {
              <div class="d-flex align-items-center">
                <button
                  pButton
                  pRipple
                  type="button"
                  class="hover-action p-button-text"
                  [pTooltip]="tooltip"
                  (click)="
                    addObjective({
                      targetId: step.recipeId,
                      unit: ObjectiveUnit.Machines
                    })
                  "
                >
                  <span
                    class="p-button-icon"
                    [class]="step.recipeId | iconSmClass: 'recipe'"
                  >
                    @if (step.recipeObjectiveId) {
                      <span>#{{ step.recipeObjectiveId }}</span>
                    }
                  </span>
                  <i class="hover-icon fa-solid fa-circle-plus"></i>
                  <ng-template #tooltip>
                    <lab-tooltip
                      [id]="step.recipeId"
                      type="recipe"
                    ></lab-tooltip>
                  </ng-template>
                </button>
                <span
                  style="
                    width: 60em;
                    white-space: nowrap;
                    mask-image: linear-gradient(90deg, #000 80%, transparent);
                    overflow: hidden;
                  "
                  >{{ step.recipe.name }}</span
                >

                @if (data().game === Game.Satisfactory) {
                  <p-inputNumber
                    #overclockInput
                    suffix="%"
                    [min]="1"
                    [max]="250"
                    [step]="10"
                    [maxFractionDigits]="2"
                    [size]="3"
                    inputStyleClass="text-end"
                    [pTooltip]="'steps.overclockTooltip' | translate"
                    [ngModel]="step.recipeSettings.overclock"
                    (onBlur)="
                      changeRecipeField(
                        step,
                        overclockInput.value ?? 100,
                        machinesState(),
                        data(),
                        RecipeField.Overclock
                      )
                    "
                  >
                  </p-inputNumber>
                }
                @if (data().game === Game.FinalFactory) {
                  <p-inputNumber
                    #duplicatorsInput
                    [min]="0"
                    [step]="1"
                    [maxFractionDigits]="0"
                    [showButtons]="true"
                    [size]="3"
                    inputStyleClass="text-end"
                    [pTooltip]="'steps.modifierCountTooltip' | translate"
                    incrementButtonClass="p-button-text"
                    decrementButtonClass="p-button-text"
                    [ngModel]="step.recipeSettings.overclock"
                    (onBlur)="
                      changeRecipeField(
                        step,
                        duplicatorsInput.value ?? 0,
                        machinesState(),
                        data(),
                        RecipeField.Overclock
                      )
                    "
                  >
                  </p-inputNumber>
                }
                @if (step.recipeSettings?.fuelId; as fuelId) {
                  @if (step.recipe.isBurn) {
                    <div class="d-flex align-items-center">
                      <i
                        class="padded"
                        [class]="fuelId | iconSmClass"
                        [pTooltip]="tooltip"
                      >
                        <ng-template #tooltip>
                          <lab-tooltip [id]="fuelId" type="fuel"></lab-tooltip>
                        </ng-template>
                      </i>
                    </div>
                  } @else {
                    <p-dropdown
                      labDropdownBase="icon"
                      [pTooltip]="tooltip"
                      [ngModel]="fuelId"
                      [options]="step.recipeSettings.fuelOptions ?? []"
                      (onChange)="
                        changeRecipeField(
                          step,
                          $event.value,
                          machinesState(),
                          data(),
                          RecipeField.Fuel
                        )
                      "
                    >
                      <ng-template pTemplate="selectedItem" let-item>
                        <div class="d-flex">
                          <i [class]="item.value | iconSmClass"></i>
                        </div>
                      </ng-template>
                      <ng-template pTemplate="item" let-item>
                        <div
                          class="d-flex align-items-center py-2 w-100 h-100"
                          [pTooltip]="tooltip"
                        >
                          <i [class]="item.value | iconSmClass"></i>
                          <div class="ms-3 text-truncate">
                            {{ item.label }}
                          </div>
                          <ng-template #tooltip>
                            <lab-tooltip
                              [id]="item.value"
                              type="fuel"
                            ></lab-tooltip>
                          </ng-template>
                        </div>
                      </ng-template>
                      <ng-template #tooltip>
                        <lab-tooltip [id]="fuelId" type="fuel"></lab-tooltip>
                      </ng-template>
                    </p-dropdown>
                  }
                }
                @if (step.recipeSettings?.moduleIds; as moduleIds) {
                  @for (
                    moduleId of moduleIds;
                    track moduleId;
                    let i = $index;
                    let last = $last
                  ) {
                    <p-dropdown
                      labDropdownBase="icon"
                      class="module-dropdown"
                      [class.last]="last"
                      [pTooltip]="moduleId !== 'module' ? tooltip : undefined"
                      tooltipPosition="top"
                      [options]="step.recipeSettings.moduleOptions ?? []"
                      [ngModel]="moduleId"
                      (onChange)="
                        changeRecipeField(
                          step,
                          $event.value,
                          machinesState(),
                          data(),
                          RecipeField.Modules,
                          i
                        )
                      "
                    >
                      <ng-template pTemplate="selectedItem" let-item>
                        @if (item) {
                          <div class="d-flex">
                            <i [class]="item.value | iconSmClass"></i>
                          </div>
                        }
                      </ng-template>
                      <ng-template pTemplate="item" let-item>
                        <div
                          class="d-flex align-items-center py-2 w-100 h-100"
                          [pTooltip]="
                            item.value !== 'module' ? tooltip : undefined
                          "
                        >
                          <i [class]="item.value | iconSmClass"></i>
                          <div class="ms-3 text-truncate">
                            {{ item.label }}
                          </div>
                          <ng-template #tooltip>
                            <lab-tooltip
                              [id]="item.value"
                              type="module"
                            ></lab-tooltip>
                          </ng-template>
                        </div>
                      </ng-template>
                      <ng-template #tooltip>
                        <lab-tooltip
                          [id]="moduleId"
                          type="module"
                        ></lab-tooltip>
                      </ng-template>
                    </p-dropdown>
                  }
                }
              </div>
            }
          </td>
        } @else {
          <td colspan="2"></td>
        }
        <!-- Beacons -->
        @if (columnsState().beacons.show) {
          @if (step.recipeId && step.recipeSettings) {
            <td class="w-0 pe-0">
              @for (
                beacon of step.recipeSettings.beacons;
                track beacon;
                let i = $index
              ) {
                <div class="d-flex">
                  @if (i === 0) {
                    <button
                      pButton
                      pRipple
                      type="button"
                      class="p-button-text p-button-rounded"
                      icon="fa-solid fa-plus"
                      (click)="
                        addBeacon(
                          step.recipeObjectiveId ?? step.recipeId,
                          step.recipeObjectiveId != null
                        )
                      "
                    ></button>
                  } @else {
                    <button
                      pButton
                      pRipple
                      type="button"
                      class="p-button-text p-button-rounded"
                      icon="fa-solid fa-xmark"
                      (click)="
                        removeBeacon(
                          step.recipeObjectiveId ?? step.recipeId,
                          i,
                          step.recipeObjectiveId != null
                        )
                      "
                    ></button>
                  }
                  @if (beacon.count) {
                    <lab-input-number
                      [pTooltip]="'steps.beaconEachTooltip' | translate"
                      tooltipPosition="left"
                      class="text-end"
                      width="2.5rem"
                      [value]="beacon.count"
                      [textButtons]="true"
                      (setValue)="
                        changeRecipeField(
                          step,
                          $event,
                          machinesState(),
                          data(),
                          RecipeField.BeaconCount,
                          i
                        )
                      "
                    ></lab-input-number>
                  }
                </div>
              }
            </td>
            <td class="ps-0">
              @for (
                beacon of step.recipeSettings.beacons;
                track beacon;
                let i = $index
              ) {
                <div class="d-flex">
                  @if (beacon.id) {
                    <p-dropdown
                      labDropdownBase="icon"
                      [pTooltip]="tooltip"
                      [options]="options().beacons"
                      [ngModel]="beacon.id"
                      (onChange)="
                        changeRecipeField(
                          step,
                          $event.value,
                          machinesState(),
                          data(),
                          RecipeField.Beacon,
                          i
                        )
                      "
                    >
                      <ng-template pTemplate="selectedItem" let-item>
                        @if (item) {
                          <div class="d-flex">
                            <i [class]="item.value | iconSmClass"></i>
                          </div>
                        }
                      </ng-template>
                      <ng-template pTemplate="item" let-item>
                        <div
                          class="d-flex align-items-center py-2 w-100 h-100"
                          [pTooltip]="tooltip"
                        >
                          <i [class]="item.value | iconSmClass"></i>
                          <div class="ms-3 text-truncate">
                            {{ item.label }}
                          </div>
                          <ng-template #tooltip>
                            <lab-tooltip
                              [id]="item.value"
                              type="beacon"
                            ></lab-tooltip>
                          </ng-template>
                        </div>
                      </ng-template>
                      <ng-template #tooltip>
                        <lab-tooltip
                          [id]="beacon.id"
                          type="beacon"
                        ></lab-tooltip>
                      </ng-template>
                    </p-dropdown>
                  }
                  @for (
                    moduleId of beacon.moduleIds;
                    track moduleId;
                    let j = $index;
                    let last = $last
                  ) {
                    <p-dropdown
                      labDropdownBase="icon"
                      class="module-dropdown"
                      [class.last]="last"
                      [pTooltip]="moduleId !== 'module' ? tooltip : undefined"
                      tooltipPosition="top"
                      [options]="beacon.moduleOptions ?? []"
                      [ngModel]="moduleId"
                      (onChange)="
                        changeRecipeField(
                          step,
                          $event.value,
                          machinesState(),
                          data(),
                          RecipeField.BeaconModules,
                          i,
                          j
                        )
                      "
                    >
                      <ng-template pTemplate="selectedItem" let-item>
                        @if (item) {
                          <div class="d-flex">
                            <i [class]="item.value | iconSmClass"></i>
                          </div>
                        }
                      </ng-template>
                      <ng-template pTemplate="item" let-item>
                        <div
                          class="d-flex align-items-center py-2 w-100 h-100"
                          [pTooltip]="
                            item.value !== 'module' ? tooltip : undefined
                          "
                        >
                          <i [class]="item.value | iconSmClass"></i>
                          <div class="ms-3 text-truncate">
                            {{ item.label }}
                          </div>
                          <ng-template #tooltip>
                            <lab-tooltip
                              [id]="item.value"
                              type="module"
                            ></lab-tooltip>
                          </ng-template>
                        </div>
                      </ng-template>
                      <ng-template #tooltip>
                        <lab-tooltip
                          [id]="moduleId"
                          type="module"
                        ></lab-tooltip>
                      </ng-template>
                    </p-dropdown>
                  }
                  @if (beacon.total) {
                    <lab-input-number
                      [pTooltip]="'steps.beaconTotalTooltip' | translate"
                      class="text-end"
                      width="3rem"
                      [value]="beacon.total"
                      [textButtons]="true"
                      (setValue)="
                        changeRecipeField(
                          step,
                          $event,
                          machinesState(),
                          data(),
                          RecipeField.BeaconTotal,
                          i
                        )
                      "
                    ></lab-input-number>
                  }
                </div>
              }
            </td>
          } @else {
            <td colspan="2"></td>
          }
        }
        <!-- Power -->
        @if (columnsState().power.show) {
          <td class="text-end">
            @if (step.power && step.power.nonzero()) {
              <span class="monospace">{{
                step.power
                  | power: columnsState().power.precision : effectivePowerUnit()
              }}</span>
            }
          </td>
        }
        <!-- Pollution -->
        @if (columnsState().pollution.show) {
          <td class="text-end">
            @if (step.pollution && step.pollution.nonzero()) {
              <span class="monospace">{{
                step.pollution | rate: columnsState().pollution.precision
              }}</span>
            }
          </td>
        }
        <!-- Link -->
        @if (columnsState().link.show) {
          <td class="w-0 px-1">
            <div class="d-flex">
              <a
                class="text-decoration-none"
                target="_blank"
                [href]="step | stepHref: routerSvc.zipConfig() : data()"
              >
                <button
                  pButton
                  pRipple
                  type="button"
                  class="p-button-text p-button-rounded"
                  icon="fa-solid fa-arrow-up-right-from-square"
                  [pTooltip]="'steps.openNewTabTooltip' | translate"
                  tooltipPosition="left"
                ></button>
              </a>
              @if (
                (step.recipeId && stepsModified().recipes[step.recipeId]) ||
                (step.itemId && stepsModified().items[step.itemId]) ||
                (step.recipeObjectiveId &&
                  stepsModified().objectives[step.recipeObjectiveId])
              ) {
                <button
                  pButton
                  pRipple
                  type="button"
                  class="p-button-text p-button-rounded"
                  icon="fa-solid fa-rotate-left"
                  [pTooltip]="'steps.stepUndoTooltip' | translate"
                  tooltipPosition="left"
                  (click)="resetStep(step)"
                ></button>
              }
            </div>
          </td>
        }
      </tr>
    }
  </ng-template>
  <ng-template pTemplate="rowexpansion" let-_step>
    <!-- Details row tab menu -->
    @if (_step | asStep; as step) {
      <tr class="detail">
        <td class="px-1">
          <a
            class="text-decoration-none"
            routerLink="."
            [relativeTo]="route"
            queryParamsHandling="preserve"
            [fragment]="step.id"
          >
            <button
              pButton
              pRipple
              type="button"
              class="p-button-text p-button-rounded"
              icon="fa-solid fa-link"
            ></button>
          </a>
        </td>
        <td colspan="100">
          <p-tabMenu
            #expandTabMenu
            [model]="stepDetails()[step.id].tabs"
            [activeItem]="activeItem[step | stepId]"
            (activeItemChange)="setActiveItem(step, $event)"
          >
            <ng-template pTemplate="item" let-item>
              <a class="p-menuitem-link">
                <span
                  class="p-menuitem-icon"
                  [class]="$any(stepDetailIcon)[item.label]"
                ></span>
                <span class="p-menuitem-text">{{
                  'options.stepDetailTab.' + item.label | translate
                }}</span>
              </a>
            </ng-template>
          </p-tabMenu>
        </td>
      </tr>
      @switch (expandTabMenu.activeItem?.label) {
        @case (StepDetailTab.Item) {
          <!-- Item row details -->
          @if (stepDetails()[step.id].outputs.length) {
            <tr class="detail">
              <ng-container *ngTemplateOutlet="leftPad"></ng-container>
              <td colspan="100" class="fw-bold">
                {{ 'steps.sources' | translate }}
              </td>
            </tr>
          }
          @for (output of stepDetails()[step.id].outputs; track output) {
            @if (step.itemId) {
              <ng-container
                *ngTemplateOutlet="
                  detailRow;
                  context: {
                    items: step.items?.mul(output.value),
                    itemId: step.itemId,
                    belts: step.belts?.mul(output.value),
                    beltId: itemsState()[step.itemId].beltId,
                    wagons: step.wagons?.mul(output.value),
                    wagonId: itemsState()[step.itemId].wagonId,
                    machines: output.step?.machines,
                    machineId: output.step?.recipeSettings?.machineId,
                    recipeId: output.step?.recipeId,
                    recipeObjectiveId: output.step?.recipeObjectiveId,
                    percent: output.value,
                    percentOnDest: true,
                    destId: step.itemId,
                    inputs: output.inputs
                  }
                "
              >
              </ng-container>
            }
          }
          @if (step.parents) {
            <tr class="detail">
              <ng-container *ngTemplateOutlet="leftPad"></ng-container>
              <td colspan="100" class="fw-bold">
                {{ 'steps.destinations' | translate }}
              </td>
            </tr>
          }
          @for (
            parent of step.parents | keyvalue: trackSvc.sortByValue;
            track parent.key
          ) {
            @if (step.itemId) {
              <ng-container
                *ngTemplateOutlet="
                  detailRow;
                  context: {
                    items: step.items?.mul(parent.value),
                    itemId: step.itemId,
                    belts: step.belts?.mul(parent.value),
                    beltId: itemsState()[step.itemId].beltId,
                    wagons: step.wagons?.mul(parent.value),
                    wagonId: itemsState()[step.itemId].wagonId,
                    machines:
                      stepDetails()[step.id].outputs.length === 1
                        ? step.machines?.mul(parent.value)
                        : null,
                    machineId:
                      stepDetails()[step.id].outputs.length === 1
                        ? step.recipeSettings?.machineId
                        : null,
                    recipeId: step.recipeId,
                    recipeObjectiveId: step.recipeObjectiveId,
                    percent: parent.value,
                    destId: stepById()[parent.key]?.recipeId,
                    destRecipeObjectiveId:
                      stepById()[parent.key]?.recipeObjectiveId,
                    destIsRecipe: true,
                    outputs: parent.key === ''
                  }
                "
              >
              </ng-container>
            }
          }
        }
        @case (StepDetailTab.Recipe) {
          <!-- Recipe row details -->
          @if (step.recipe) {
            @if (data().game === Game.Factorio && step.recipe.isMining) {
              <tr class="detail">
                <ng-container *ngTemplateOutlet="leftPad"></ng-container>
                <td colspan="100" class="fw-bold">
                  {{ 'steps.depletion' | translate }}
                </td>
              </tr>
              @for (
                output of step.outputs | keyvalue: trackSvc.sortByValue;
                track output.key
              ) {
                @if (
                  {
                    step: stepByItemEntities()[output.key],
                    percent: step.outputs?.[output.key]
                  };
                  as row
                ) {
                  @if (row.step && row.percent && row.step.items) {
                    <ng-container
                      *ngTemplateOutlet="
                        detailRow;
                        context: {
                          items: row.step.items
                            .mul(row.percent)
                            .div(step.recipe.productivity),
                          itemId: output.key
                        }
                      "
                    >
                    </ng-container>
                  }
                }
              }
            }
            @if ((step.recipe.in | keyvalue).length) {
              <tr class="detail">
                <ng-container *ngTemplateOutlet="leftPad"></ng-container>
                <td colspan="100" class="fw-bold">
                  {{ 'steps.inputs' | translate }}
                </td>
              </tr>
              @for (
                input of step.recipe.in | keyvalue: trackSvc.sortByValue;
                track input.key
              ) {
                @if (
                  {
                    step: stepByItemEntities()[input.key],
                    percent: stepByItemEntities()[input.key].parents?.[step.id]
                  };
                  as row
                ) {
                  @if (row.step.itemId && row.percent) {
                    @if (
                      stepDetails()[row.step.id].outputs.length === 1 &&
                        stepDetails()[row.step.id].outputs[0];
                      as output
                    ) {
                      <ng-container
                        *ngTemplateOutlet="
                          detailRow;
                          context: {
                            items: row.step.items?.mul(row.percent),
                            itemId: input.key,
                            belts: row.step.belts?.mul(row.percent),
                            beltId: itemsState()[row.step.itemId].beltId,
                            wagons: row.step.wagons?.mul(row.percent),
                            wagonId: itemsState()[row.step.itemId].wagonId,
                            machines: output.step?.machines,
                            machineId: output.step?.recipeSettings?.machineId,
                            recipeId: output.step?.recipeId,
                            recipeObjectiveId: output.step?.recipeObjectiveId,
                            percent: row.percent,
                            destId: step.recipeId,
                            destRecipeObjectiveId: step.recipeObjectiveId,
                            destIsRecipe: true
                          }
                        "
                      >
                      </ng-container>
                    } @else {
                      <ng-container
                        *ngTemplateOutlet="
                          detailRow;
                          context: {
                            items: row.step.items?.mul(row.percent),
                            itemId: input.key,
                            belts: row.step.belts?.mul(row.percent),
                            beltId: itemsState()[row.step.itemId].beltId,
                            wagons: row.step.wagons?.mul(row.percent),
                            wagonId: itemsState()[row.step.itemId].wagonId,
                            percent: row.percent,
                            destId: step.recipeId,
                            destRecipeObjectiveId: step.recipeObjectiveId,
                            destIsRecipe: true
                          }
                        "
                      >
                      </ng-container>
                    }
                  }
                }
              }
            }
            <tr class="detail">
              <ng-container *ngTemplateOutlet="leftPad"></ng-container>
              <td colspan="100" class="fw-bold">
                {{ 'steps.time' | translate }}
              </td>
            </tr>
            <tr class="detail">
              <ng-container *ngTemplateOutlet="leftPad"></ng-container>
              <td class="w-0 text-end">
                <span class="monospace">{{
                  step.recipe.time | rate: columnsState().items.precision
                }}</span>
              </td>
              <td class="ps-0">
                <div class="d-flex"><i class="lab-icon time"></i></div>
              </td>
              <td colspan="100"></td>
            </tr>
            <tr class="detail">
              <ng-container *ngTemplateOutlet="leftPad"></ng-container>
              <td colspan="100" class="fw-bold">
                {{ 'steps.outputs' | translate }}
              </td>
            </tr>
            @for (
              output of step.recipe.out | keyvalue: trackSvc.sortByValue;
              track output.key
            ) {
              @if (
                {
                  step: stepByItemEntities()[output.key],
                  percent: step.outputs?.[output.key]
                };
                as row
              ) {
                @if (row.step.itemId && row.percent) {
                  <ng-container
                    *ngTemplateOutlet="
                      detailRow;
                      context: {
                        items: row.step.items?.mul(row.percent),
                        itemId: output.key,
                        belts: row.step.belts?.mul(row.percent),
                        beltId: itemsState()[row.step.itemId].beltId,
                        wagons: row.step.wagons?.mul(row.percent),
                        wagonId: itemsState()[row.step.itemId].wagonId,
                        machines: step.machines,
                        machineId: step.recipeSettings?.machineId,
                        recipeId: step.recipeId,
                        recipeObjectiveId: step.recipeObjectiveId,
                        percent: row.percent,
                        percentOnDest: true,
                        destId: output.key,
                        destRecipeObjectiveId: step.recipeObjectiveId
                      }
                    "
                  >
                  </ng-container>
                }
              }
            }
          }
        }
        @case (StepDetailTab.Machine) {
          <!-- Machine row details -->
          <tr class="detail">
            <td></td>
            <td colspan="100">
              @if (step.recipeId && step.recipe && step.machines) {
                <div class="d-flex align-items-center">
                  <table class="mw-0">
                    @for (
                      input of step.recipe.in | keyvalue: trackSvc.sortByValue;
                      track input.key
                    ) {
                      @if (
                        {
                          step: stepByItemEntities()[input.key],
                          percent:
                            stepByItemEntities()[input.key].parents?.[step.id]
                        };
                        as row
                      ) {
                        @if (row.percent) {
                          <tr>
                            <td>
                              @if (row.step.items) {
                                <ng-container
                                  *ngTemplateOutlet="
                                    machineValueCell;
                                    context: {
                                      value:
                                        row.step.items
                                          .mul(row.percent)
                                          .div(step.machines)
                                        | rate: columnsState().items.precision,
                                      itemId: input.key
                                    }
                                  "
                                >
                                </ng-container>
                              }
                            </td>
                            @if (columnsState().belts.show) {
                              <td>
                                @if (row.step.belts) {
                                  @if (
                                    itemsState()[input.key].beltId;
                                    as beltId
                                  ) {
                                    <ng-container
                                      *ngTemplateOutlet="
                                        machineValueCell;
                                        context: {
                                          value:
                                            row.step.belts
                                              .mul(row.percent)
                                              .div(step.machines)
                                            | rate
                                              : columnsState().belts.precision,
                                          itemId: beltId
                                        }
                                      "
                                    >
                                    </ng-container>
                                  }
                                }
                              </td>
                            }
                            @if (data().game === Game.Factorio) {
                              <td>
                                @if (
                                  itemsState()[input.key].beltId !==
                                    ItemId.Pipe && row.step.items
                                ) {
                                  @if (
                                    row.step.items
                                      .mul(row.percent)
                                      .div(step.machines)
                                      .div(dispRateInfo().value)
                                      | inserterSpeed: settings();
                                    as ins
                                  ) {
                                    <ng-container
                                      *ngTemplateOutlet="
                                        machineValueCell;
                                        context: {
                                          value: ins.value | rate: 1,
                                          itemId: ins.id
                                        }
                                      "
                                    >
                                    </ng-container>
                                  }
                                }
                              </td>
                            }
                          </tr>
                        }
                      }
                    }
                  </table>
                  <i class="fa-solid fa-arrow-right mx-3"></i>
                  <table class="mw-0">
                    <tr>
                      <td class="w-0 text-end">
                        <span class="monospace">{{
                          rational(1) | rate: columnsState().machines.precision
                        }}</span>
                      </td>
                      <td>
                        @if (step.recipeSettings?.machineId; as machineId) {
                          <div class="d-flex align-items-center">
                            <i
                              [class]="step.recipeId | iconClass: 'recipe'"
                              [pTooltip]="tooltip"
                            >
                              <ng-template #tooltip>
                                <lab-tooltip [id]="step.recipeId" type="recipe">
                                </lab-tooltip>
                              </ng-template>
                            </i>
                            <i
                              [class]="machineId | iconClass"
                              [pTooltip]="tooltip"
                            >
                              <ng-template #tooltip>
                                <lab-tooltip
                                  [id]="machineId"
                                  type="machine"
                                ></lab-tooltip>
                              </ng-template>
                            </i>
                          </div>
                        }
                      </td>
                    </tr>
                    <tr>
                      <td class="w-0 text-end">
                        <span class="monospace">{{
                          dispRateInfo().value
                            | rate: columnsState().machines.precision
                        }}</span>
                      </td>
                      <td><i class="lab-icon time"></i></td>
                    </tr>
                  </table>
                  <i class="fa-solid fa-arrow-right mx-3"></i>
                  <table class="mw-0">
                    @for (
                      output of step.recipe.out
                        | keyvalue: trackSvc.sortByValue;
                      track output.key
                    ) {
                      @if (output.value.div(step.recipe.time); as items) {
                        <tr>
                          @if (data().game === Game.Factorio) {
                            <td>
                              @if (
                                itemsState()[output.key].beltId !== ItemId.Pipe
                              ) {
                                @if (
                                  items | inserterSpeed: settings();
                                  as ins
                                ) {
                                  <ng-container
                                    *ngTemplateOutlet="
                                      machineValueCell;
                                      context: {
                                        value: ins.value | rate: 1,
                                        itemId: ins.id
                                      }
                                    "
                                  >
                                  </ng-container>
                                }
                              }
                            </td>
                          }
                          @if (columnsState().belts.show) {
                            <td>
                              @if (itemsState()[output.key].beltId; as beltId) {
                                <ng-container
                                  *ngTemplateOutlet="
                                    machineValueCell;
                                    context: {
                                      value:
                                        items.div(beltSpeed()[beltId])
                                        | rate: columnsState().belts.precision,
                                      itemId: beltId
                                    }
                                  "
                                >
                                </ng-container>
                              }
                            </td>
                          }
                          <td>
                            <ng-container
                              *ngTemplateOutlet="
                                machineValueCell;
                                context: {
                                  value:
                                    items.mul(dispRateInfo().value)
                                    | rate: columnsState().items.precision,
                                  itemId: output.key
                                }
                              "
                            >
                            </ng-container>
                          </td>
                        </tr>
                      }
                    }
                  </table>
                  <ng-template
                    #machineValueCell
                    let-value="value"
                    let-itemId="itemId"
                  >
                    <div class="d-flex align-items-center justify-content-end">
                      <span class="monospace">{{ value }}</span>
                      <i [class]="itemId | iconClass" [pTooltip]="tooltip">
                        <ng-template #tooltip>
                          <lab-tooltip [id]="itemId"></lab-tooltip>
                        </ng-template>
                      </i>
                    </div>
                  </ng-template>
                </div>
              }
              @if (data().game === Game.Factorio) {
                <small
                  [innerHTML]="'steps.inserterCountInfo' | translate"
                ></small>
              }
            </td>
          </tr>
        }
        @case (StepDetailTab.Recipes) {
          <!-- Recipes row details -->
          @if (step.itemId && stepDetails()[step.id]; as stepDetails) {
            <tr class="detail">
              <td></td>
              <td colspan="100">
                <div>
                  <div class="fw-bold">
                    {{ 'steps.includedRecipes' | translate }}
                  </div>
                  <div class="mb-2">
                    <small>{{ 'steps.includedRecipesInfo' | translate }}</small>
                  </div>
                  <p-checkbox
                    [ngModel]="stepDetails.allRecipesIncluded"
                    [binary]="true"
                    [label]="'picker.includeAll' | translate"
                    (onChange)="
                      toggleRecipes(
                        stepDetails.recipeIds,
                        stepDetails.allRecipesIncluded,
                        data()
                      )
                    "
                  ></p-checkbox>
                </div>
              </td>
            </tr>
            <tr class="detail">
              <td></td>
              <td colspan="100">
                <div class="d-flex flex-wrap">
                  @for (recipeId of stepDetails.recipeIds; track recipeId) {
                    <button
                      pButton
                      pRipple
                      type="button"
                      class="p-button-text hover-action me-2"
                      [class.hover-active]="recipesState()[recipeId].excluded"
                      [icon]="recipeId | iconSmClass: 'recipe'"
                      [pTooltip]="tooltip"
                      (click)="toggleRecipe(recipeId, recipesState(), data())"
                    >
                      <i class="hover-icon fa-solid fa-eye-slash"></i>
                      <ng-template #tooltip>
                        <lab-tooltip
                          [id]="recipeId"
                          type="recipe"
                        ></lab-tooltip>
                      </ng-template>
                    </button>
                  }
                </div>
              </td>
            </tr>
          }
        }
      }
    }
  </ng-template>
  <ng-template pTemplate="emptymessage">
    @if (focus()) {
      <tr>
        <td colspan="100">
          <div class="d-flex justify-content-center">
            <span>{{ 'steps.emptyMessage' | translate }}</span>
          </div>
        </td>
      </tr>
    }
  </ng-template>
  <ng-template #emptyCol2>
    <td colspan="2"></td>
  </ng-template>
  <ng-template #leftPad>
    <td></td>
    @if (!focus()) {
      @if (columnsState().checkbox.show) {
        <td></td>
      }
      @if (columnsState().tree.show) {
        <td></td>
      }
    }
  </ng-template>
  <ng-template
    #detailRow
    let-items="items"
    let-itemId="itemId"
    let-belts="belts"
    let-beltId="beltId"
    let-wagons="wagons"
    let-wagonId="wagonId"
    let-machines="machines"
    let-machineId="machineId"
    let-recipeId="recipeId"
    let-recipeObjectiveId="recipeObjectiveId"
    let-percent="percent"
    let-percentOnDest="percentOnDest"
    let-destId="destId"
    let-destRecipeObjectiveId="destRecipeObjectiveId"
    let-destIsRecipe="destIsRecipe"
    let-inputs="inputs"
    let-outputs="outputs"
  >
    <tr class="detail">
      @if (itemId) {
        <ng-container *ngTemplateOutlet="leftPad"></ng-container>
        <td class="w-0 text-end">
          <span class="monospace">{{
            items | rate: columnsState().items.precision
          }}</span>
        </td>
        <td class="ps-0">
          <div class="d-flex">
            <i [class]="itemId | iconClass" [pTooltip]="tooltip">
              <ng-template #tooltip>
                <lab-tooltip [id]="itemId"></lab-tooltip>
              </ng-template>
            </i>
          </div>
        </td>
        @if (columnsState().belts.show && belts && beltId) {
          <td class="w-0 text-end">
            <span class="monospace">{{
              belts | rate: columnsState().belts.precision
            }}</span>
          </td>
          <td class="ps-0">
            <div class="d-flex">
              <i [class]="beltId | iconClass" [pTooltip]="tooltip">
                <ng-template #tooltip>
                  <lab-tooltip [id]="beltId" type="belt"></lab-tooltip>
                </ng-template>
              </i>
            </div>
          </td>
        }
        @if (columnsState().wagons.show && wagons && wagonId) {
          <td class="w-0 text-end">
            <span class="monospace">{{
              wagons | rate: columnsState().wagons.precision
            }}</span>
          </td>
          <td class="ps-0">
            <div class="d-flex">
              @if (data().cargoWagonIds.indexOf(wagonId) !== -1) {
                <i [class]="wagonId | iconClass" [pTooltip]="tooltip">
                  <ng-template #tooltip>
                    <lab-tooltip
                      [id]="wagonId"
                      type="cargo-wagon"
                    ></lab-tooltip>
                  </ng-template>
                </i>
              } @else {
                <i [class]="wagonId | iconClass" [pTooltip]="tooltip">
                  <ng-template #tooltip>
                    <lab-tooltip
                      [id]="wagonId"
                      type="fluid-wagon"
                    ></lab-tooltip>
                  </ng-template>
                </i>
              }
            </div>
          </td>
        }
        <td class="w-0 text-end">
          @if (
            machines &&
            machines.nonzero() &&
            (machineId | machineShowRate: data().game)
          ) {
            <span class="monospace">{{
              machines
                | machineRate: columnsState().machines.precision : machineId
            }}</span>
          }
        </td>
        <td class="p-0" colspan="100">
          <div class="d-flex align-items-center">
            @if (inputs) {
              <div class="position-absolute">
                {{ 'steps.inputs' | translate }}
              </div>
            }
            @if (machineId | machineShow: data().game) {
              <i [class]="recipeId | iconClass: 'recipe'" [pTooltip]="tooltip">
                @if (recipeObjectiveId) {
                  <span>#{{ recipeObjectiveId }}</span>
                }
                <ng-template #tooltip>
                  <lab-tooltip [id]="recipeId" type="recipe"></lab-tooltip>
                </ng-template>
              </i>
              <i [class]="machineId | iconClass" [pTooltip]="tooltip">
                <ng-template #tooltip>
                  <lab-tooltip [id]="machineId" type="machine"></lab-tooltip>
                </ng-template>
              </i>
            } @else {
              <div class="d-flex invisible">
                <i class="lab-icon"></i>
              </div>
              <div class="d-flex invisible">
                <i class="lab-icon"></i>
              </div>
            }
            @if (percent) {
              @if (percentOnDest) {
                <i class="m-1 p-2 fa-solid fa-arrow-right"></i>
              }
              <span class="monospace">{{ percent | rate: -2 | leftPad }}%</span>
              @if (!percentOnDest) {
                <i class="m-1 p-2 fa-solid fa-arrow-right"></i>
              }
              @if (destId) {
                <i
                  [class]="
                    destId | iconClass: (destIsRecipe ? 'recipe' : 'item')
                  "
                  [pTooltip]="tooltip"
                >
                  @if (destRecipeObjectiveId) {
                    <span>#{{ destRecipeObjectiveId }}</span>
                  }
                  <ng-template #tooltip>
                    <lab-tooltip
                      [id]="destId"
                      [type]="destIsRecipe ? 'recipe' : 'item'"
                    ></lab-tooltip>
                  </ng-template>
                </i>
              }
              @if (outputs) {
                <span>
                  {{ 'steps.outputs' | translate }}
                </span>
              }
            }
          </div>
        </td>
      }
    </tr>
  </ng-template>
  <ng-template pTemplate="footer">
    @if (!focus()) {
      <tr>
        <td></td>
        @if (columnsState().checkbox.show) {
          <td></td>
        }
        @if (columnsState().tree.show) {
          <td></td>
        }
        <td colspan="2">
          {{ 'steps.total' | translate }}
        </td>
        <ng-container
          *ngTemplateOutlet="
            totalCell;
            context: {
              columnSettings: columnsState().belts,
              totals: totals().belts,
              type: 'belt'
            }
          "
        >
        </ng-container>
        <ng-container
          *ngTemplateOutlet="
            totalCell;
            context: {
              columnSettings: columnsState().wagons,
              totals: totals().wagons
            }
          "
        >
        </ng-container>
        <ng-container
          *ngTemplateOutlet="
            totalCell;
            context: {
              columnSettings: columnsState().machines,
              totals: totals().machines,
              modulesTotals: totals().modules,
              type: 'machine'
            }
          "
        >
        </ng-container>
        <ng-container
          *ngTemplateOutlet="
            totalCell;
            context: {
              columnSettings: columnsState().beacons,
              totals: totals().beacons,
              modulesTotals: totals().beaconModules,
              type: 'beacon'
            }
          "
        >
        </ng-container>
        @if (columnsState().power.show) {
          <td class="text-end inherit">
            <span class="monospace">{{
              totals().power
                | power: columnsState().power.precision : effectivePowerUnit()
            }}</span>
          </td>
        }
        @if (columnsState().pollution.show) {
          <td class="text-end inherit">
            <span class="monospace">{{
              totals().pollution | rate: columnsState().pollution.precision
            }}</span>
          </td>
        }
        @if (columnsState().link.show) {
          <td></td>
        }
      </tr>
    }
    <ng-template
      #totalCell
      let-columnSettings="columnSettings"
      let-totals="totals"
      let-type="type"
      let-modulesTotals="modulesTotals"
    >
      @if (columnSettings.show) {
        <td class="w-0 text-end inherit">
          <table>
            @for (
              tot of totals | keyvalue: trackSvc.sortByValue;
              track tot.key
            ) {
              <tr>
                <td>
                  <span class="monospace">{{
                    tot.value | rate: columnSettings.precision
                  }}</span>
                </td>
                <td style="text-align: left">
                  <span class="monospace">{{
                    data().itemEntities[tot.key].name
                  }}</span>
                </td>
              </tr>
            }
          </table>
        </td>
      }
    </ng-template>
  </ng-template>
</p-table>
